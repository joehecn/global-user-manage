(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>R});const r=require("casbin"),n=require("casbin-basic-adapter"),o=require("koa-authz/BasicAuthorizer.js"),a=class extends o{async checkPermission(){const{ctx:e,enforcer:t}=this,{url:r,method:n}=e,{role:o,dom:a}=e.state.auth,s=r.split("?")[0];try{return await t.enforce(o.sub,a,s,n)}catch(e){return console.error(e),!1}}};let s=null;const i=require("crypto"),c=require("pg"),{Pool:u}=c;let l=null;const d=require("util"),p=require("pg-format"),y=require("moment");function h(e,t){if(d.types.isRegExp(t))return e.includes("->")?p(`${e} ~* %L`,t.toString().replace(/\//g,"")):p("%I ~* %L",e,t.toString().replace(/\//g,""));if("boolean"==typeof t)return p(`${e} = %s`,t.toString());if("string"==typeof t)return e.includes("->")?p(`${e} = %L`,t):["path @>","path <@"].includes(e)?p(`${e} %L`,t):t.includes("IS NOT NULL")&&e===t?t:p("%I = %L",e,t);if("object"==typeof t){if(y.isDate(t))return p(`${e} %L`,t);t.$in&&(t=`ANY('{${t.$in.join(",")}}')`)}return e.includes("->")?p(`${e} = %s`,t):p("%I = %s",e,t)}class g{constructor(e){this.callCounted=!1,this.query={SELECT:"*",FROM:`public.${e}`,WHERE:null,"ORDER BY":null,OFFSET:null,LIMIT:null}}find(e={},t={}){if(this.callCounted)return this;if(e&&"object"==typeof e){const t=[];for(const r in e){const n=e[r];"$or"===r?t.push(`(${n.map((e=>{const t=Object.keys(e)[0];return h(t,e[t])})).join(" OR ")})`):t.push(h(r,n))}t.length>0&&(this.query.WHERE=t.join(" AND "))}if(t&&"object"==typeof t){const e=[],r=[];for(const n in t){const o=t[n];o&&(1===o?(e.push("%I"),r.push(n)):(e.push("%s"),r.push(p("%I AS %I",n,o))))}r.length>0&&(this.query.SELECT=p.withArray(e.join(", "),r))}return this}count(){return this.callCounted=!0,this.query.SELECT="count(*)::int",this}sort(e){if(this.query["ORDER BY"]="id DESC",e&&"object"==typeof e){const t=[];for(const r in e)r.includes("->")?1===e[r]?t.push(r):t.push(`${r} DESC`):1===e[r]?t.push(p("%I",r)):t.push(p("%I DESC",r));t.length>0&&(this.query["ORDER BY"]=t.join(", "))}return this}offset(e=0){const t=parseInt(e);return isNaN(t)||(this.query.OFFSET=t),this}limit(e=10){const t=parseInt(e);return isNaN(t)||(this.query.LIMIT=t),this}exec(){const e=[],t=[];return["SELECT","FROM","WHERE","ORDER BY","OFFSET","LIMIT"].forEach((r=>{const n=this.query[r];n&&(e.push("%s","%s"),t.push(r,n))})),p.withArray(e.join(" "),t)}}function w(e){return new g(e)}const E='id AS "globalId", icon, email, phone, country_code AS "countryCode", is_active AS "isActive", note, created_at AS "createdAt", nick_name AS "nickName"';let b=null;const m={getRbacPgPoll:e=>{if(!l){const t=new u(e);t.on("connect",(e=>{e.on("error",(e=>{console.error("----- rbacPgPool client connect error"),console.error(e),process.exit(-1)}))})),t.on("error",(e=>{console.error("----- rbacPgPool error"),console.error(e),process.exit(-1)})),l=t}return l},init:(e,t)=>{if(b)return b;const r=(e=>async t=>{const r=await e.connect();try{return await r.query(t)}catch(e){throw console.log("------ q error:"),console.error(e),e}finally{r.release()}})(e),n=e=>new Promise(((r,n)=>{i.pbkdf2(e,t,512,64,"sha1",((e,t)=>{e?n(e):r(t.toString("hex"))}))})),o=async(e,t,o,a)=>{const s=await n(a),i=`SELECT ${E}\n      FROM public.global_user\n      WHERE (email=$3 OR (country_code=$1 AND phone=$2)) AND password_hash=$4 AND is_active=true`,c=[e,t,o,s],{rows:u}=await r({name:"global-user-getByPhoneOrEmailAndPassword",text:i,values:c});return u[0]};return b={list:async e=>{const{countText:t,text:n}=(({where:e,select:t,sort:r,offset:n,limit:o})=>({countText:w("global_user").find(e).count().exec(),text:w("global_user").find(e,t).sort(r).offset(n).limit(o).exec()}))(e),o=await r({text:t}),{rows:a}=await r({text:n});return{totalCount:o.rows[0].count,list:a}},get:async e=>{const t=`SELECT ${E}\n      FROM public.global_user\n      WHERE id = $1`,{rows:n}=await r({name:"global-user-get",text:t,values:[e]});return n[0]},getActiveUserById:async e=>{const t=`SELECT ${E}\n      FROM public.global_user\n      WHERE id = $1 AND is_active = true`,{rows:n}=await r({name:"global-user-get-active-user-by-id",text:t,values:[e]});return n[0]},getByIdAndPassword:async(e,t)=>{const o=await n(t),a=`SELECT ${E}\n      FROM public.global_user\n      WHERE id = $1 AND password_hash = $2 AND is_active = true`,s=[e,o],{rows:i}=await r({name:"global-user-getByIdAndPassword",text:a,values:s});return i[0]},getByPhoneOrEmail:async(e,t,n)=>{const o=`SELECT ${E}\n      FROM public.global_user\n      WHERE email=$3 OR (country_code=$1 AND phone=$2)`,{rows:a}=await r({name:"global-user-getByPhoneOrEmail",text:o,values:[e,t,n]});return a[0]},getByPhoneOrEmailAndPassword:o,getByPhone:async(e,t)=>{const n=`SELECT ${E}\n      FROM public.global_user\n      WHERE country_code=$1 AND phone=$2`,o=[e,t],{rows:a}=await r({name:"global-user-getByPhone",text:n,values:o});return a[0]},create:async([e,t,a,s,i,c,u,l])=>{let d=await o(e,t,a,s);return d||(d=await(async e=>{e[3]=await n(e[3]);const t=`INSERT INTO public.global_user(\n      country_code, phone, email, password_hash, is_active, note, email_verified, nick_name)\n      VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n      RETURNING ${E}`,{rows:o}=await r({name:"global-user-create",text:t,values:e});return o[0]})([e,t,a,s,i,c,u,l]),d)},update:async e=>{const t=`UPDATE public.global_user\n      SET country_code=$2, phone=$3, email=$4, is_active=$5, nick_name=$6\n      WHERE id=$1\n      RETURNING ${E}`,{rows:n}=await r({name:"global-user-update",text:t,values:e});return n[0]},updatePassword:async(e,t)=>{const o=[e,await n(t)],{rows:a}=await r({name:"global-user-updatePassword",text:"UPDATE public.global_user\n      SET password_hash=$2\n      WHERE id=$1",values:o});return a[0]}},b}},f=require("koa-authz"),{getRbacPgPoll:$,init:P}=m,R=(e,t,o)=>{const i=$(e),c=P(i,t);let u=null;return o&&(u=((e,t)=>{if(s)return s;const o=((e,t)=>{let o=null;return async()=>{if(o)return o;const a=await n.BasicAdapter.newAdapter("pg",e);return o=await(0,r.newEnforcer)(t,a),o}})(e,t);return s={authzArg:{newEnforcer:async()=>await o(),authorizer:(e,t)=>new a(e,t)},initOnePolicy:async e=>{const t=await o();await t.hasNamedPolicy("p",...e)||await t.addNamedPolicy("p",...e)},initOneGroup:async e=>{const t=await o();await t.hasNamedGroupingPolicy("g",...e)||await t.addNamedGroupingPolicy("g",...e)},addGroupingPolicy:async e=>{const t=await o();return await t.addNamedGroupingPolicy("g",...e)},removeGroupingPolicy:async e=>{const t=await o();return await t.removeNamedGroupingPolicy("g",...e)},setRolePermissions:async(e,t,r)=>{const n=await o(),a=await n.removeFilteredNamedPolicy("p",0,e,t),s=r.map((r=>[e,t,...r]));return{removed:a,added:await n.addNamedPolicies("p",s)}},getPermissionsForRole:async(e,t)=>{const r=await o();return await r.getFilteredNamedPolicy("p",0,e,t)}},s})(i,o)),{globalUserServices:c,rbac:u,authz:f}};var _=exports;for(var S in t)_[S]=t[S];t.__esModule&&Object.defineProperty(_,"__esModule",{value:!0})})();